{% extends 'base.html' %}
{% load static %}
{% block content %}
<div id="location-display">
    <p>Recording your location...</p>
</div>

<script>
// Helper function to get the CSRF token from cookies.
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to send the geolocation data to the update_location view.
function sendLocation(position) {
    const data = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude
    };

    fetch('/update-location/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Location update response:', data);
        if (data.status === 'success') {
            document.getElementById('location-display').innerHTML = `
                <p>Latest recorded location:</p>
                <p>
                    Latitude: ${data.latitude}<br>
                    Longitude: ${data.longitude}<br>
                    Recorded at: ${data.recorded_at}
                </p>
            `;
        } else {
            document.getElementById('location-display').innerHTML = `<p>Error recording location.</p>`;
        }
    })
    .catch(error => {
        console.error('Error updating location:', error);
        document.getElementById('location-display').innerHTML = `<p>Error recording location.</p>`;
    });
}

// Function to get the current geolocation and call sendLocation.
function updateUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(sendLocation, function(error) {
            console.error("Error obtaining geolocation:", error);
            document.getElementById('location-display').innerHTML = `<p>Error obtaining location.</p>`;
        });
    } else {
        console.error("Geolocation is not supported by this browser.");
        document.getElementById('location-display').innerHTML = `<p>Geolocation not supported by this browser.</p>`;
    }
}

// On page load, update location every 10 seconds.
window.onload = function() {
    updateUserLocation();
    setInterval(updateUserLocation, 10000);
};

        <!-- Right Column (Sidebar) -->
        <div class="col-lg-4 col-md-5">
            <div class="sidebar-box p-4 border rounded">
                <h4>Dashboard</h4>
                <container class="d-flex flex-column m-3 justify-content-center">
                    <div class = "dropdown width:100%">
                        <button class="btn width:100% btn-secondary dropdown-toggle mt-2" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <a class="text-white">Report illness</a>
                        </button>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="{% url 'App:report_illness'%}?type=physical">Physical Illness</a>
                            <a class="dropdown-item" href="{% url 'App:report_illness'%}?type=airborne">Airborne Illness</a>
                            <a class="dropdown-item" href="{% url 'App:learn' %}">Not sure?</a>
                          </div>
                    </div>
                    <button class="btn btn-secondary mt-2">
                        <a class="text-white" href="{% url 'App:notify' %}">Notify user</a>
                    </button>
                    <button class="btn btn-secondary mt-2">
                        <a class="text-white" href="{% url 'App:learn' %}">Learn more</a>
                    </button>
                </container>
            </div>
        </div>
    </div>
</div>

window.addEventListener('unload', function() {
    // Use navigator.sendBeacon if available.
    if (navigator.sendBeacon) {
        const url = '/finalize-location/';
        // The Beacon API sends data as a Blob or FormData.
        const data = new FormData();
        // Optionally include CSRF token if needed (some backends may not verify for sendBeacon).
        data.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        navigator.sendBeacon(url, data);
    } else {
        // Fallback: a synchronous XMLHttpRequest.
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/finalize-location/", false);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.send("csrfmiddlewaretoken=" + getCookie('csrftoken'));
    }
});
</script>

{% endblock %}
